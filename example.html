<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
  </head>
  <body>
    <script type="text/javascript">
      module = { exports: {} }
    </script>
    <textarea></textarea>
    <pre></pre>
    <pre></pre>
    <script type="text/javascript" src="index.js"></script>
    <script type="text/javascript">
      const Parser = module.exports

      const emojis = {
        ':lol:': 'ü§£',
        ':pear:': 'üçê'
      }

      const p = new Parser({
        onlink(link) {
          console.log('got link', link)
          if (p.setLink(link)) {
            inp.value = p.text
            inp.selectionStart = p.position
            inp.selectionEnd = p.position
          }
        },
        onmention(mention) {
          console.log('got mention', mention)
          if (p.setMention(mention, mention, Math.random())) {
            inp.value = p.text
            inp.selectionStart = p.position
            inp.selectionEnd = p.position
          }
        },
        onemoji(emoji) {
          if (emojis[emoji]) {
            console.log('got emoji')
            if (p.setEmoji(emoji, emoji, emojis[emoji])) {
              console.log('set text', p.text)
              inp.value = p.text
              inp.selectionStart = p.position
              inp.selectionEnd = p.position
            }
          }
        }
      })

      const inp = document.getElementsByTagName('textarea')[0]
      const echo = document.getElementsByTagName('pre')[0]
      const result = document.getElementsByTagName('pre')[1]

      inp.oninput = function (e) {
        if (e.inputType === 'deleteContentBackward') {
          p.backspace()
        } else if (
          e.inputType === 'insertText' ||
          e.inputType === 'insertFromPaste'
        ) {
          p.appendText(e.data)
        } else if (e.inputType === 'insertLineBreak') {
          p.appendText('\n')
        }
        echo.innerText = p.text
        result.innerText = 'pos=' + p.position + ' word=' + p.word + '\n'
        result.innerText += JSON.stringify(p.display, null, 2)
      }

      inp.onselectionchange = function (e) {
        const start = inp.selectionStart
        const end = inp.selectionEnd

        if (start !== p.position) p.setPosition(start)
        if (start !== end) p.selectRange(start, end)
      }
    </script>
  </body>
</html>
